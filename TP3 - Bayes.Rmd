---
title: |
  \vspace{1cm}
  \begin{tabular}{c}
  {\normalsize\textbf{UNIVERSIDAD NACIONAL DE ROSARIO}}\\
  {\Large Facultad de Ciencias Económicas y Estadística}\\
  \\
  \\
  \includegraphics[width=5cm]{LogoUNR.png}\\
  \\
  \\
  {\huge\textbf{Análisis de una masacre}}\\
  {\huge\textbf{utilizando modelos lineales bayesianos}}\\
  \\
  {\Large Estadística Bayesiana - Trabajo Práctico Nº3}\\
  \end{tabular}
  \vspace{4cm}
  \begin{flushright}
    \includegraphics[width=4cm]{chuky.png}
  \end{flushright}
author: |
  Alumnas: Agustina Mac Kay, Ailén Salas y Rocío Canteros
date: "Año 2024"
output: pdf_document
editor_options: 
  markdown: 
    wrap: sentence
  chunk_output_type: console
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.height = 3)
```

```{r}
# Carga de librerías
library(ggplot2)
library(dplyr)
library(kableExtra)
library(rstan)
library(bayesplot)
library(tidyr)

set.seed(425641446)
```

## Introducción

La tanatocronología, derivada de las palabras griegas "thanatos" (muerte) y "chronos" (tiempo), es un subcampo de la medicina forense que se centra en determinar el intervalo postmortem, es decir, el tiempo transcurrido desde la muerte hasta el descubrimiento del cadáver.[^1]

[^1]: Fuente: [\textcolor{blue}{\underline{Diccionario Médico: tanatocronología - Clínica Universidad de Navarra}}](https://www.cun.es/diccionario-medico/terminos/tanatocronologia#:~:text=La%20tanatocronolog%C3%ADa%2C%20derivada%20de%20las,hasta%20el%20descubrimiento%20del%20cad%C3%A1ver.)

Desde el momento de la muerte, comienza en el cuerpo humano una serie de procesos químicos y físicos que se conocen como fenómenos cadavéricos.
Uno de ellos es el enfriamiento del cuerpo (enfriamiento postmortem o *algor mortis*).
En este proceso, la temperatura del cadáver desciende hasta igualarse con la temperatura ambiente.
Este descenso ocurre más rápido en las primeras horas después de la muerte.

El objetivo de este trabajo es averiguar la hora de muerte de Sergio Contreras, un hombre que fue hallado muerto desangrado, producto de una herida punzante recibida en el bazo, en su casa en la localidad cordobesa de Salsipuedes.
Para resolver este acertijo, se cuenta con la siguiente información sobre la temperatura del cuerpo sin vida del hombre:

-   5:33 hs - El Centro de Atención de Emergencias 911 recibe un llamado de Lidia Benegas, alertando sobre ruidos extraños en la vivienda de su vecino en la localidad de Salsipuedes.

-   6:00 hs - La policia arriba al lugar y se constata la presencia de un cuerpo tendido en el suelo.

-   6:45 hs - Arriba la policía científica al lugar del crimen, se determina la ausencia de signos vitales en el cuerpo de Sergio y el médico forense informa una temperatura corporal de 32.8 °C.

-   8:15hs - Finalizados los procedimientos legales y técnicos, se coloca el cuerpo en la bolsa de óbito para ser trasladado a morgue judicial.
    El termómetro registra que la temperatura del cadáver es de 30.5 °C.

-   13:30 hs - Comienza la autopsia.
    El cadáver se encuentra a 23.7 °C.

## Sección con nombre ????

Como el ritmo con el cual el cuerpo pierde temperatura no es constante, se puede pensar que la derivada de la temperatura respecto al tiempo varía con el tiempo.
En este caso, la temperatura del cadáver satisface la siguiente ley: $$ \frac{dT(t)}{dt} = r[T_{\text{amb}}-T(t)] \tag{1} $$ donde $T_{\text{amb}}$ es la temperatura ambiente (un valor fijo y conocido), $r$ es una constante y $T(t)$ es la función (por ahora desconocida) que describe la temperatura del cuerpo en función del tiempo.

Una posible función $T(t)$ es: $$ T(t)=T_{\text{amb}} + (T_i - T_{\text{amb}}) \cdot e^{-rt} $$ siendo $T_i$ la temperatura a la que está inicialmente el cuerpo.

La misma satisface la ecuación $(1)$ ya que: $$ \frac{dT(t)}{dt} = (T_i - T_{\text{amb}}) \cdot (-r) \cdot e^{-rt} = $$ $$ = -r \cdot [(T_i - T_{\mathrm{amb}}) \cdot e^{-rt}] = $$ $$ = -r \cdot [-T_{\mathrm{amb}}+T_{\mathrm{amb}}+(T_i - T_{\mathrm{amb}}) \cdot e^{-rt}] = $$ $$ = -r \cdot [-T_{\mathrm{amb}}+T(t)] = $$ $$ = r \cdot [T_{\mathrm{amb}} - T(t)] $$ Se grafica a continuación la función $T(t)$ para distintos valores de la constante $r$, considerando una temperatura inicial del cuerpo de 37 Cº y una temperatura ambiente de 23 Cº.

```{r}
# Gráfico de la temperatura del cuerpo a través del tiempo
t_amb <- 23
t_i <- 37
t <- seq(0, 35, by = 1)
r <- c(0.05, 0.1, 0.15, 0.2, 0.3)

funcion_t <- function(t_amb, t_i, t, r) {
  t_amb + (t_i- t_amb) * exp(-r*t)
}

funcion_t_vector <- Vectorize(funcion_t)

df_T <- data.frame(
  t_amb = t_amb,
  t_i = t_i,
  t = rep(seq(0, 35, by = 1), times = length(r)),
  r = rep(r, each = length(t))
)

df_T <- df_T %>% 
  mutate(func_t = funcion_t_vector(df_T$t_amb, df_T$t_i, df_T$t, df_T$r))

ggplot(df_T) +
  geom_line(aes(x = t, y = func_t, color = factor(r)), linewidth = 1) +
  scale_x_continuous(breaks = seq(0, 40, by = 5), name = "Hora (t)") +
  scale_y_continuous(breaks = seq(23, 39, by = 2), name = "T(t)") +
  scale_color_manual(values = c("orchid3", "palegreen3", 'hotpink', 'gold3', 'firebrick3'), name = "r") +
  geom_hline(yintercept = 23, linetype = "dashed") +
  labs(caption = "Figura 1: Gráfica de la función de descenso de la temperatura corporal T(t) para 2 valores de la constante r,\n con una temperatura inicial del cuerpo de 37 Cº hasta alcanzar una temperatura ambiente de 23 Cº") +
  theme_bw() +
  theme(plot.caption = element_text(hjust = 0.5))
```

*r* es una constante que representa la conductividad entre el cuerpo y la superficie de contacto.
A valores más altos de *r*, más rápido será el descenso de la temperatura corporal.

Los órganos abdominales pueden mantener el calor por al menos 24 horas.
En las primeras 12 horas se va perdiendo el calor de 0.8 a 1.0 grado centígrado por hora y en las siguientes 12 horas de 0.3 a 0.5 grados centígrados.[^2]

[^2]: Fuente: [\textcolor{blue}{\underline{Fenómenos cadavéricos - Valentina Gómez Hernández}}](https://repository.unad.edu.co/bitstream/handle/10596/51040/vgomezh.pdf?sequence=3&isAllowed=y#:~:text=Enfriamiento%20Cadav%C3%A9rico%20o%20Algor%20Mortis,equilibra%20con%20el%20medio%20ambiente.)

Teniendo en cuenta esta información y lo observado en la Figura 1, se puede considerar que un valor razonable para *r* se encuentra entre 0.1 y 0.2.

## Postulación del modelo

Para mayor simplicidad a la hora de construir un modelo, en lugar de trabajar con la temperatura del cuerpo se decide utilizar la diferencia entre la temperatura del mismo y la temperatura ambiente $T(t) - T_{\mathrm{amb}}$.
Además, se define $T_{\mathrm{diff}} = T_i - T_{\mathrm{amb}}$; por lo que se obtiene finalmente que $T(t) - T_{\mathrm{amb}} = T_{\mathrm{diff}} \cdot e ^ {-rt}$.

Se demuestra a continuación un resultado que será de vital importancia para la construcción de un modelo: el logaritmo natural de la nueva variable $T(t) - T_{\mathrm{amb}}$ es una función lineal de *t*.

$$ \ln(T(t) - T_{\mathrm{amb}}) = \ln( T_{\mathrm{diff}} \cdot e^{-rt}) = \ln(T_{\mathrm{diff}}) + (-rt) \cdot \ln (e) = \ln(T_{\mathrm{diff}}) - rt = \beta_{0} + \beta_{1}\cdot t \tag{2}$$

Se puede interpretar a $\beta_{0}$ como el valor del $\ln(T(t) - T_{\mathrm{amb}})$ cuando $t=0$.
Al exponenciar ambos miembros se obtiene que $$ T(t=0) - T_{\mathrm{amb}} = e^{\beta_0}$$ Si se toma como tiempo cero el momento de la primera medición, entonces la temperatura del cuerpo en ese momento es igual a $e^{\beta_0} + T_{\mathrm{amb}}$

$\beta_1$ es el opuesto de la constante de conductividad.
Representa el cambio en el logaritmo de la diferencia entre la temperatura corporal y la temperatura ambiente por cada hora transcurrida.

Para determinar la hora de muerte de Sergio, se trabajará con un modelo lineal bayesiano; se determinarán creencias a priori para los parámetros desconocidos para luego actualizarlas con las mediciones de temperatura que se realizaron al cuerpo del hombre.
Para este proceso, se considera que la temperatura ambiente (constante a través del tiempo) es de 22ºC.

El modelo propuesto incompleto, porque faltan las distribuciónes a priori de sus parámetros, es el siguiente:

$$
\begin{cases} 
\ln(T(t) - T_{\mathrm{amb}}) \sim\mathcal{N}_{(\mu, \sigma)} \\
\mu = \beta_{0} + \beta_{1}\cdot t
\end{cases}
$$

Se asignarán distribuciones a priori para los parámetros desconocidos $\beta_0$, $\beta_1$ y $\sigma$.
Si bien $\mu$ también es desconocido, no se le asigna un prior propio ya que su valor depende exclusivamente de $\beta_0$ y $\beta_1$, de forma que una vez asignados valores para estos dos parámetros, $\mu$ queda definido.

Como se menciona en la ecuación (2), $\beta_0$ es el $\ln(T_{\mathrm{diff}}) = \ln(T_i - T_{\mathrm{amb}})$.
Se sabe que la temperatura ambiente es de 22ºC, mientras que la temperatura inicial del cuerpo se encuentra entre 36,5ºC y 37,5ºC (temperatura habitual del cuerpo humano).
Con esto se puede decir que el valor mínimo para $\beta_0$ es $\ln(36,5^\circ-22^\circ)=\ln(14,5^\circ)=2,67^\circ$, y el máximo es $\ln(37,5^\circ-22^\circ)= \ln(15,5^\circ)=2,74^\circ$.

Con este rango de valores, se puede suponer a priori una distribución normal para $\beta_0$, de media $\mu_{\beta_0} = \frac{2.74 + 2.67}{2}=2.705$ y desvío $\sigma_{\beta_0} = \frac{2.74-2.705}{3} = 0.012$, quedando así definido su *prior*.

**CAMBIO:** el tiempo 0 es el momento de la primer medición.
Sabemos que a las 5:33hs la vecina de Sergio escuchó ruidos provenientes de su casa, y la primer medición de temperatura se hizo a las 6:45hs.
Entonces, podemos pensar que al momento de la primer medición Sergio llevaba muerto entre 1 y 2 horas.
En ese tiempo, de esperar que la temperatura de su cuerpo haya descendido entre 2 y 6 grados, como mucho.
Si consideramos la temperatura normal del cuerpo humano en 36.5ºC, entonces el $\ln(T(t) - T_{\mathrm{amb}})$ máximo es $\ln((36.5-2) - 22) = 2.526$ y el mínimo es $\ln((36.5-6) - 22) = 2.14$ Entonces podemos decir que $\beta_0$ tiene a priori una distribución normal con media $\mu_{\beta_0} = \frac{2.526 + 2.14}{2}=2.333$ y desvío $\sigma_{\beta_0} = \frac{2.526-2.333}{3} = 0.064$

Para definir una distribución para $\beta_1$, se puede utilizar la Figura 1; si bien el gráfico se realizó para una temperatura ambiente 1ºC más alta que la actual, las conclusiones son las mismas.
Entonces, si un valor razonable para *r* se encuentra entre 0.1 y 0.2, se puede decir que $\beta_1 = -r$ toma valores entre -0.2 y -0.1.

Si nuevamente se utiliza una distribución normal, se obtiene que $\beta_1 \sim \mathcal{N}(\mu_{\beta_1},\sigma_{\beta_1})$, con media $\mu_{\beta_1} = \frac{-0.2-0.1}{2} = -0.15$ y desvío $\sigma_{\beta_1} = \frac{-0.1+0.15}{3} = 0.033$.

**CAMBIO:** sin embargo, como Sergio murió desangrado y la pérdida de sangre puede acelerar el descenso de la temperatura corporal, se permitirá que *-r* tome valores entre -0.3 y -0.15.
Por eso se propone a priori una distribución normal de media $\mu_{\beta_1} = \frac{-0.3-0.15}{2} = -0.225$ y desvío $\sigma_{\beta_1} = \frac{-0.15+0.225}{3} = 0.025$.

Por último, $sigma$ es el desvío del $\ln(T(t) - T_{\mathrm{amb}})$.
La diferencia máxima entre la temperatura ambiente (22ºC) y $T(t)$ se da cuando $T(t)$ es máxima (37,5º).
En ese caso, $\ln(37.5-22)=2.74$.
La diferencia mínima es de cero grados, y se da cuando la temperatura del cuerpo alcanza la temperatura ambiente, pero ahí el logaritmo no existe.

Como el desvío de una distribución es estrictamente positivo, se propone para el mismo una distribución Half-normal, con desvío $\sigma_\sigma = \frac{2.74}{3} = 0.91$.

Por lo tanto, si se consideran independientes los parámetros entre sí, el modelo con las distribuciones a priori propuestas es:

$$
\begin{cases}
\ln(T(t) - T_{\mathrm{amb}}) \sim\mathcal{N}_{(\mu, \sigma)} \\
\mu = \beta_{0} + \beta_{1}\cdot t \\
\\
\beta_0 \sim \mathcal{N}_{(2.705, 0.012)} \\
\beta_1 \sim \mathcal{N}_{(-0.15, 0.017)} \\
\sigma \sim \mathcal{N}^{+}_{(0.91)}
\end{cases}
$$ Se realizan pruebas predictivas a priori para este modelo.

```{r}
mu_b0 <- 2.333
sigma_b0 <- 0.064
mu_b1 <- -0.225
sigma_b1 <- 0.025

observaciones <- tibble(tiempo = c(0, 1.5, 6.75),
                        y = c(2.38,2.14,0.53))

parametros <-
  expand.grid(b0 = seq(mu_b0-(3*sigma_b0), mu_b0+(3*sigma_b0),length.out = 50),
              b1 = seq(mu_b1-(3*sigma_b1), mu_b1+(3*sigma_b1),length.out = 50)) |>
  mutate(prior = purrr::map2_dbl(
    b0, b1,~mvtnorm::dmvnorm(x = c(.x,.y),
                                   mean = c(mu_b0, mu_b1),
                                   sigma = diag(c(sigma_b0, sigma_b1),2))))

rectas_prior <- 
  ggplot(data = observaciones) +
  geom_point(aes(x=tiempo, y=y), size = 3) +
  geom_abline(data = parametros %>%
  slice_sample(n = 50, weight_by = prior), mapping = aes(slope=b1, intercept=b0),alpha = 0.3, size = 1) +
  # lims(x=c(-2,7),y=c(0.4,3)) +
  lims ( x= c(-3,7.5),y=c(0.5,4)) +
  theme_bw() +
  labs(caption = 'Figura 2: rectas predictivas a priori')

rectas_prior
```

Podemos ver que el prior es bastante compatible con las observaciones.
También notamos que los 3 puntos no están alineados.
Esto puede deberse a que, si bien probamos que el logaritmo natural $T(t) - T_{\mathrm{amb}}$ es una función lineal de *t*, estamos suponiendo que la temperatura ambiente es fija cuando la última medición se realizó habiendo trasladado el cuerpo, por lo que sería raro que la temperatura ambiente realmente se mantenga.

## Primer observación

Se actualiza el modelo con el primer dato observado: la temperatura del cuerpo de Sergio en la primer medición (6:45hs) fue de 32.8ºC.

```{r, warning=FALSE, results='hide'}
# Modelo actualizado con 1 sola observación
datos1 <- data.frame(
  t = c(0),
  temp = c(32.8)
)

t_amb <- 22

stan_data1 <- list(
  N = nrow(datos1),
  t = array(datos1$t,dim=1),
  temp_obs= array(datos1$temp, dim=1),
  y = array(log(datos1$temp - t_amb), dim=1)
)

#str(stan_data1)

stan_model1 <- stan(
  file = "modelo.stan",
  chains = 4,
  data = stan_data1,
  refresh = 1,
  seed = 20000,
  iter=3000,
  warmup = 1500,
  control = list(adapt_delta = 0.95)
)

summary(stan_model1)
```

$$
\begin{array}{c|cc|cc}
\text{Parámetro} &\text{Media} &\text{desvío} & \hat{R} & \text{Número efectivo de muestras} \\
\hline
\beta_0 & 2.344 & 0.059 & 1.0009 & 2746 \\
\beta_1 & -0.20 & 0.033 & 1.0005 & 3174 \\
\sigma & 0.347 & 0.383 & 1.0016 & 3275 \\
\end{array}
$$ Los 3 parámetros tienen buen $\hat{R}$ y un número efectivo de muestras muy alto.

Trace plots:

```{r}
# Evaluamos la calidad de las muestras
mcmc_trace(
  stan_model1, 
  pars = c("beta0", "beta1", "sigma"),
  facet_args = list(nrow = 3)
)
```

Las cadenas parece que convergen todas

Entonces, el modelo a posteriori con 1 observación es:

$$
\begin{cases}
\ln(T(t) - T_{\mathrm{amb}}) \sim\mathcal{N}_{(\mu, \sigma)} \\
\mu = \beta_{0} + \beta_{1}\cdot t \\
\\
\beta_0 \sim \mathcal{N}_{(2.344, 0.059)} \\
\beta_1 \sim \mathcal{N}_{(-0.2, 0.033)} \\
\sigma \sim \mathcal{N}^{+}_{(????)}
\end{cases}
$$

```{r}
# Primera observacion
datos_transf1 <- data.frame(
  t = c(0),
  temp = c(log(32.8-22))
)

calc_likelihood <- function(datos, b0, b1, sd){
  lik_i <- dnorm(datos$temp, b0+b1*datos$t, sd)
  return(prod(lik_i))
}

dv1 <-
  datos_transf1 %>% 
  slice(1) %>% 
  tidyr::crossing(parametros) %>% 
  nest(datos_transf1 = c(t,temp)) %>%
  mutate(likelihood = purrr::pmap_dbl(list(datos = datos_transf1, 
                                           b0 = parametros$b0, 
                                           b1 = parametros$b1, sd = 0.6),
                                      calc_likelihood)) %>%
  mutate(posterior = likelihood*prior) %>%
  select(-datos_transf1)

# Obtenemos las rectas muestreadas de b0 y b1
muestra1 <- dv1 %>% 
  slice_sample(n = 50, weight_by = posterior)

# Obtenemos el intervalo de la muerte de Sergio
y_objetivo <- log(36.5-22)
intercepto_rectas1 <- data.frame(b0 = muestra1$b0, b1=muestra1$b1)
intercepto_rectas1 <-  intercepto_rectas1 %>%
  mutate(t = (y_objetivo - b0)/b1)
lim_inf1 <- min(intercepto_rectas1$t)
lim_sup1 <- max(intercepto_rectas1$t)

# Función para convertir las rectas en curvas, transformando la variable Y
generacion_datos_curvas <- function(b0, b1) {
  data.frame(
    t = seq(-4, 8, by = 0.1),
    T_t = 22 + exp(b0 + b1 * seq(-4, 8, by = 0.1))
  )
}

# Creamos un data frame con todas las curvas
datos_curvas1 <- muestra1 %>%
  group_by(b0, b1) %>%
  do(generacion_datos_curvas(.$b0, .$b1))

# Graficamos las observaciones y las curvas
rectas_posterior1 <-
  ggplot(datos1) +
  geom_line(data = datos_curvas1,
            mapping = aes(x = t, y = T_t,group = interaction(b0, b1)),
            alpha = 0.3, size = 1) +
  geom_hline(yintercept = 36.5, linetype = "dashed")  +
  geom_point(data=observaciones, aes(x=tiempo, y=exp(y)+22), size = 3) +
  geom_point(aes(x = t, y = temp), size = 4, color = "firebrick3") +
  geom_vline(xintercept = lim_inf1) +
  geom_vline(xintercept = lim_sup1) +
  labs(x="Tiempo en horas",y="T(t)", caption = "figura xxxxxxxxxx")+
  scale_x_continuous( breaks = seq(-4, 8, by = 2), labels = seq(2.45, 14.45, by = 2),expand = c(0, 0)) +
  theme_bw()


rectas_posterior1
```

Según este nuevo modelo, Serio murió entre el tiempo -0.3 y 0.3.
Malísimo.
Una sola observación no fue suficiente para "bajar" el b0

## Modelo con 2 obs

```{r, results='hide'}
datos2 <- data.frame(
  t = c(0, 1.5),
  temp = c(32.8, 30.5)
)

stan_data2 <- list(
  N = nrow(datos2),
  t = datos2$t,
  temp_obs= datos2$temp,
  y = log(datos2$temp - t_amb)
)

#str(stan_data2)

stan_model2 <- stan(
  file = "modelo.stan",
  chains = 4,
  data = stan_data2,
  refresh = 1,
  seed = 20000,
  iter= 2500,
  warmup = 1500,
  control = list(adapt_delta = 0.95)
)

summary(stan_model2)
```

$$
\begin{array}{c|cc|cc}
\text{Parámetro} &\text{Media} &\text{desvío} & \hat{R} & \text{Número efectivo de muestras} \\
\hline
\beta_0 & 2.362 & 0.048 & 1.005 & 1242 \\
\beta_1 & -0.16 & 0.031 & 1.006 & 1157 \\
\sigma & 0.162 & 0.214 & 1.004 & 1021 \\
\end{array}
$$

El número efectivo de muestras ya no es tan grande pero el $\hat{R}$ sigue siendo bueno.

```{r, eval=FALSE}
mcmc_trace(
  stan_model2, 
  pars = c("beta0", "beta1", "sigma"),
  facet_args = list(nrow = 3)
)
```

todas mezcladas.
eso es bueno.
recorren bien la distri

La muestra parece ser buena Ahora, el modelo actualizado es:

$$
\begin{cases}
\ln(T(t) - T_{\mathrm{amb}}) \sim\mathcal{N}_{(\mu, \sigma)} \\
\mu = \beta_{0} + \beta_{1}\cdot t \\
\\
\beta_0 \sim \mathcal{N}_{(2.362, 0.048)} \\
\beta_1 \sim \mathcal{N}_{(-0.16, 0.031)} \\
\sigma \sim \mathcal{N}^{+}_{(????)}
\end{cases}
$$

Vemos posibles rectas con el nuevo modelo

```{r}
datos_transf2 <- data.frame(
  t = c(0, 1.5),
  temp = c(log(32.8-22),log(30.5-22))
)

dv2 <-
  datos_transf2 %>% 
  slice(c(1,2)) %>%
  tidyr::crossing(parametros) %>% 
  nest(datos_transf2 = c(t,temp)) %>%
  mutate(likelihood = purrr::pmap_dbl(list(datos = datos_transf2, b0 = parametros$b0, b1 = parametros$b1, sd = 0.6),
                                      calc_likelihood)) %>%
  mutate(posterior = likelihood*prior) %>%
  select(-datos_transf2) 

# Obtenemos las rectas muestreadas de b0 y b1
muestra2 <- dv2 %>% 
  slice_sample(n = 50, weight_by = posterior)

# Obtenemos el intervalo de la muerte de Sergio
y_objetivo <- log(36.5-22)
intercepto_rectas2 <- data.frame(b0 = muestra2$b0, b1=muestra2$b1)
intercepto_rectas2 <-  intercepto_rectas2 %>%
  mutate(t = (y_objetivo - b0)/b1)
lim_inf2 <- min(intercepto_rectas2$t)
lim_sup2 <- max(intercepto_rectas2$t)

# Función para convertir las rectas en curvas, transformando la variable Y
generacion_datos_curvas <- function(b0, b1) {
  data.frame(
    t = seq(-4, 8, by = 0.1),
    T_t = 22 + exp(b0 + b1 * seq(-4, 8, by = 0.1))
  )
}

# Creamos un data frame con todas las curvas
datos_curvas2 <- muestra2 %>%
  group_by(b0, b1) %>%
  do(generacion_datos_curvas(.$b0, .$b1))

# Graficamos las observaciones y las curvas
rectas_posterior2 <-
  ggplot(datos2) +
  geom_line(data = datos_curvas2,
            mapping = aes(x = t, y = T_t,group = interaction(b0, b1)),
            alpha = 0.3, size = 1) +
  geom_hline(yintercept = 36.5, linetype = "dashed")  +
  geom_point(data=observaciones, aes(x=tiempo, y=exp(y)+22), size = 3) +
  geom_point(aes(x = t, y = temp), size = 4, color = "firebrick3") +
  geom_vline(xintercept = lim_inf2) +
  geom_vline(xintercept = lim_sup2) +
  labs(x="Tiempo en horas",y="T(t)", caption = "figura xxxxxxxxxx")+
 scale_x_continuous( breaks = seq(-4, 8, by = 2), labels = seq(2.45, 14.45, by = 2),expand = c(0, 0)) +
  theme_bw()

rectas_posterior2
```

Sergio se murió aprox entre...

## Modelo con 3 obs

```{r, results='hide'}
#Se arma una tabla con las temperaturas del cuerpo observadas y los tiempos
datos3 <- data.frame(
  t = c(0, 1.5, 6.75),
  temp = c(32.8, 30.5, 23.7)
)

t_amb <- 22

stan_data3 <- list(
  N = nrow(datos3),
  t = datos3$t,
  temp_obs= datos3$temp,
  y = log(datos3$temp - t_amb)
)

str(stan_data3)

stan_model3 <- stan(
  file = "modelo.stan",
  chains = 4,
  data = stan_data3,
  refresh = 1,
  seed = 20000,
  iter = 2500,
  # warmup = 1500,
  control = list(adapt_delta = 0.95)
)

summary(stan_model3)
```

$$
\begin{array}{c|cc|cc}
\text{Parámetro} &\text{Media} &\text{desvío} & \hat{R} & \text{Número efectivo de muestras} \\
\hline
\beta_0 & 2.333 & 0.061 & 1.001 & 2883 \\
\beta_1 & -0.23 & 0.029 & 1.008 & 1744 \\
\sigma & 0.334 & 0.232 & 1.006 & 1981 \\
\end{array}
$$

Los $\hat{R}$ son todos buenos y los números efectivos de muestras también.

```{r, eval=FALSE}
mcmc_trace(
  stan_model3, 
  pars = c("beta0", "beta1", "sigma"),
  facet_args = list(nrow = 3)
)
```

todas mezcladas.
eso es bueno.
el sigma no esta tan bueno.
RARI recorren bien la distri

La muestra parece ser buena

Ahora, el modelo actualizado es:

$$
\begin{cases}
\ln(T(t) - T_{\mathrm{amb}}) \sim\mathcal{N}_{(\mu, \sigma)} \\
\mu = \beta_{0} + \beta_{1}\cdot t \\
\\
\beta_0 \sim \mathcal{N}_{(2.333, 0.061)} \\
\beta_1 \sim \mathcal{N}_{(-0.23, 0.029)} \\
\sigma \sim \mathcal{N}^{+}_{(???)}
\end{cases}
$$

```{r}
datos_transf3 <- data.frame(
  t = c(0, 1.5, 6.75),
  temp = c(log(32.8-22),log(30.5-22), log(23.7-22))
)

dv3 <-
  datos_transf3 %>% 
  slice(c(1,2,3)) %>%
  tidyr::crossing(parametros) %>% 
  nest(datos_transf3 = c(t,temp)) %>%
  mutate(likelihood = purrr::pmap_dbl(
    list(datos = datos_transf3, b0 = parametros$b0, b1 = parametros$b1,
         sd = 0.6),calc_likelihood)) %>%
  mutate(posterior = likelihood*prior) %>%
  select(-datos_transf3) 

# Obtenemos las rectas muestreadas de b0 y b1
muestra3 <- dv3 %>% 
  slice_sample(n = 50, weight_by = posterior)

# Obtenemos el intervalo de la muerte de Sergio
y_objetivo <- log(36.5-22)
intercepto_rectas <- data.frame(b0 = muestra3$b0, b1=muestra3$b1)
intercepto_rectas <-  intercepto_rectas %>%
  mutate(t = (y_objetivo - b0)/b1)
lim_inf3 <- min(intercepto_rectas$t)
lim_sup3 <- max(intercepto_rectas$t)

# Función para convertir las rectas en curvas, transformando la variable Y
generacion_datos_curvas <- function(b0, b1) {
  data.frame(
    t = seq(-4, 8, by = 0.1),
    T_t = 22 + exp(b0 + b1 * seq(-4, 8, by = 0.1))
  )
}

# Creamos un data frame con todas las curvas
datos_curvas3 <- muestra3 %>%
  group_by(b0, b1) %>%
  do(generacion_datos_curvas(.$b0, .$b1))

# Graficamos las observaciones y las curvas
rectas_posterior3 <-
  ggplot(datos3) +
  geom_line(data = datos_curvas3,
            mapping = aes(x = t, y = T_t,group = interaction(b0, b1)),
            alpha = 0.3, size = 1) +
  geom_hline(yintercept = 36.5, linetype = "dashed")  +
  geom_point(aes(x = t, y = temp), size = 4, color = "firebrick3") +
  geom_vline(xintercept = lim_inf3) +
  geom_vline(xintercept = lim_sup3) +
  labs(x="Tiempo en horas",y="T(t)", caption = "figura xxxxxxxxxx")+
 scale_x_continuous( breaks = seq(-4, 8, by = 2), labels = seq(2.45, 14.45, by = 2),expand = c(0, 0)) +
  theme_bw()

rectas_posterior3
```

Sergio se murió...

## ¿What if... Sergio estaba enfermo?

Fue mencionado anteriormente que la pérdida de sangre por hemorragia puede acelerar el enfriamiento del cadáver.
Otro factor a considerar es la presencia de enfermedades.
Las enfermedades crónicas aceleran el enfriamiento del cuerpo, mientras que otras, como la fiebre, lo retardan.[^3]

[^3]: Fuente: [\textcolor{blue}{\underline{Fenómenos cadavéricos y el tanatocronodiagnóstico}}](chrome-extension://efaidnbmnnnibpcajpcglclefindmkaj/https://www.uv.es/gicf/3R1_Pen%CC%83a_GICF_31.pdf)

Si Sergio hubiese tenido una enfermedad al momento de su muerte, se deberían modificar las distribuciones a priori para $\beta_1$ y $\beta_0$ de modo que sus medias sean menores.
