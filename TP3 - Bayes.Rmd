---
title: |
  \vspace{1cm}
  \begin{tabular}{c}
  {\normalsize\textbf{UNIVERSIDAD NACIONAL DE ROSARIO}}\\
  {\Large Facultad de Ciencias Económicas y Estadística}\\
  \\
  \\
  \includegraphics[width=5cm]{LogoUNR.png}\\
  \\
  \\
  {\huge\textbf{Análisis de temperatura corporal postmortem}}\\
  {\huge\textbf{utilizando modelos lineales bayesianos}}\\
  \\
  {\Large Estadística Bayesiana - Trabajo Práctico Nº3}\\
  \end{tabular}
  \vspace{4cm}
author: |
  Alumnas: Agustina Mac Kay, Ailén Salas y Rocío Canteros
date: "Año 2024"
output: pdf_document
editor_options: 
  markdown: 
    wrap: sentence
  chunk_output_type: console
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.height = 3)
```

```{r}
# Carga de librerías
library(ggplot2)
library(dplyr)
library(kableExtra)
library(rstan)
library(bayesplot)
library(tidyr)
```
# Introducción

La tanatocronología, derivada de las palabras griegas "thanatos" (muerte) y "chronos" (tiempo), es un subcampo de la medicina forense que se centra en determinar el intervalo postmortem, es decir, el tiempo transcurrido desde la muerte hasta el descubrimiento del cadáver.[^1]

[^1]: Fuente: [\textcolor{blue}{\underline{Diccionario Médico: tanatocronología - Clínica Universidad de Navarra}}](https://www.cun.es/diccionario-medico/terminos/tanatocronologia#:~:text=La%20tanatocronolog%C3%ADa%2C%20derivada%20de%20las,hasta%20el%20descubrimiento%20del%20cad%C3%A1ver.)

Desde el momento de la muerte, comienza en el cuerpo humano una serie de procesos químicos y físicos que se conocen como fenómenos cadavéricos. Uno de ellos es el enfriamiento del cuerpo (enfriamiento postmortem o *algor mortis*). En este proceso, la temperatura del cadáver desciende hasta igualarse con la temperatura ambiente. Este descenso ocurre más rápido en las primeras horas después de la muerte.

El objetivo de este trabajo es averiguar la hora de muerte de Sergio Contreras, un hombre que fue hallado muerto desangrado, producto de una herida punzante recibida en el bazo, en su casa en la localidad cordobesa de Salsipuedes. Para resolver este acertijo, se cuenta con la siguiente información sobre la temperatura del cuerpo sin vida del hombre:

* 5:33 hs - El Centro de Atención de Emergencias 911 recibe un llamado de Lidia Benegas, alertando sobre ruidos extraños en la vivienda de su vecino en la localidad de Salsipuedes.

*  6:00 hs - La policia arriba al lugar y se constata la presencia de un cuerpo tendido en el suelo.

* 6:45 hs - Arriba la policía científica al lugar del crimen, se determina la ausencia de signos vitales en el cuerpo de Sergio y el médico forense informa una temperatura corporal de 32.8 °C.

* 8:15hs - Finalizados los procedimientos legales y técnicos, se coloca el cuerpo en la bolsa de óbito para ser trasladado a morgue judicial. El termómetro registra que la temperatura del cadáver es de 30.5 °C.

* 13:30 hs - Comienza la autopsia. El cadáver se encuentra a 23.7 °C.

# Sección con nombre ????

Como el ritmo con el cual el cuerpo pierde temperatura no es constante, se puede pensar que la derivada de la temperatura respecto al tiempo varía con el tiempo. En este caso, la temperatura del cadáver satisface la siguiente ley: 
$$ \frac{dT(t)}{dt} = r[T_{\text{amb}}-T(t)] \tag{1} $$
donde \(T_{\text{amb}}\) es la temperatura ambiente (un valor fijo y conocido), \(r\) es una constante y \(T(t)\) es la función (por ahora desconocida) que describe la temperatura del cuerpo en función del tiempo.

Una posible función \(T(t)\) es: 
$$ T(t)=T_{\text{amb}} + (T_i - T_{\text{amb}}) \cdot e^{-rt} $$
siendo \(T_i\) la temperatura a la que está inicialmente el cuerpo. 

La misma satisface la ecuación \((1)\) ya que:
$$ \frac{dT(t)}{dt} = (T_i - T_{\text{amb}}) \cdot (-r) \cdot e^{-rt} = $$
$$ = -r \cdot [(T_i - T_{\mathrm{amb}}) \cdot e^{-rt}] = $$
$$ = -r \cdot [-T_{\mathrm{amb}}+T_{\mathrm{amb}}+(T_i - T_{\mathrm{amb}}) \cdot e^{-rt}] = $$
$$ = -r \cdot [-T_{\mathrm{amb}}+T(t)] = $$
$$ = r \cdot [T_{\mathrm{amb}} - T(t)] $$
Se grafica a continuación la función $T(t)$ para distintos valores de la constante $r$, considerando una temperatura inicial del cuerpo de 37 Cº y una temperatura ambiente de 23 Cº.

```{r}
# Gráfico de la temperatura del cuerpo a través del tiempo
t_amb <- 23
t_i <- 37
t <- seq(0, 35, by = 1)
r <- c(0.05, 0.1, 0.15, 0.2, 0.3)

funcion_t <- function(t_amb, t_i, t, r) {
  t_amb + (t_i- t_amb) * exp(-r*t)
}

funcion_t_vector <- Vectorize(funcion_t)

df_T <- data.frame(
  t_amb = t_amb,
  t_i = t_i,
  t = rep(seq(0, 35, by = 1), times = length(r)),
  r = rep(r, each = length(t))
)

df_T <- df_T %>% 
  mutate(func_t = funcion_t_vector(df_T$t_amb, df_T$t_i, df_T$t, df_T$r))

ggplot(df_T) +
  geom_line(aes(x = t, y = func_t, color = factor(r)), linewidth = 1) +
  scale_x_continuous(breaks = seq(0, 40, by = 5), name = "Hora (t)") +
  scale_y_continuous(breaks = seq(23, 39, by = 2), name = "T(t)") +
  scale_color_manual(values = c("orchid3", "palegreen3", 'hotpink', 'gold3', 'firebrick3'), name = "r") +
  geom_hline(yintercept = 23, linetype = "dashed") +
  labs(caption = "Figura 1: Gráfica de la función de descenso de la temperatura corporal T(t) para 2 valores de la constante r,\n con una temperatura inicial del cuerpo de 37 Cº hasta alcanzar una temperatura ambiente de 23 Cº") +
  theme_bw() +
  theme(plot.caption = element_text(hjust = 0.5))
```

*r* es una constante que representa la conductividad entre el cuerpo y la superficie de contacto. A valores más altos de *r*, más rápido será el descenso de la temperatura corporal. 

Los órganos abdominales pueden mantener el calor por al menos 24 horas. En las primeras 12 horas se va perdiendo el calor de 0.8 a 1.0 grado centígrado por hora y en las siguientes 12 horas de 0.3 a 0.5 grados centígrados.[^2]

[^2]: Fuente: [\textcolor{blue}{\underline{Fenómenos cadavéricos - Valentina Gómez Hernández}}](https://repository.unad.edu.co/bitstream/handle/10596/51040/vgomezh.pdf?sequence=3&isAllowed=y#:~:text=Enfriamiento%20Cadav%C3%A9rico%20o%20Algor%20Mortis,equilibra%20con%20el%20medio%20ambiente.)

Teniendo en cuenta esta información y lo observado en la Figura 1, se puede considerar que un valor razonable para *r* se encuentra entre 0.1 y 0.2.

Para mayor simplicidad a la hora de contruir un modelo, en lugar de trabajar con la temperatura del cuerpo se decide utilizar la diferencia entre la temperatura del mismo y la temperatura ambiente $T(t) - T_{\mathrm{amb}}$. Además, se define $T_{\mathrm{diff}} = T_i - T_{\mathrm{amb}}$; por lo que se obtiene finalmente que $T(t) - T_{\mathrm{amb}} = T_{\mathrm{diff}} \cdot e ^ {-rt}$.

Se demuestra a continuación un resultado que será de vital importancia para la construcción de un modelo: el logaritmo natural de la nueva variable $T(t) - T_{\mathrm{amb}}$ es una función lineal de *t*.

$$ \ln(T(t) - T_{\mathrm{amb}}) = \ln( T_{\mathrm{diff}} \cdot e^{-rt}) = \ln(T_{\mathrm{diff}}) + (-rt) \cdot \ln (e) = \ln(T_{\mathrm{diff}}) - rt = \beta_{0} + \beta_{1}\cdot t$$

Se puede interpretar a $\beta_{0}$ como el valor del $\ln(T(t) - T_{\mathrm{amb}})$ cuando $t=0$. Al exponenciar ambos miembros se obtiene que 
$$ T(t=0) - T_{\mathrm{amb}} = e^{\beta_0}$$ 
Si se toma como tiempo cero el momento de la primera medición, entonces la temperatura del cuerpo en ese momento es igual a $e^{\beta_0} + T_{\mathrm{amb}}$

$\beta_1$ es el opuesto de la constante de conductividad. Representa el cambio en el logaritmo de la diferencia entre la temperatura corporal y la temperatura ambiente por cada hora transcurrida.

Para determinar la hora de muerte de Sergio, se trabajará con un modelo lineal bayesiano; se determinarán creencias a priori para los parámetros desconocidos para luego actualizarlas con las mediciones de temperatura que se realizaron al cuerpo del hombre. 

---

$$
\begin{cases} 
ln(T(t) - T_{\mathrm{amb}}) \sim N_{(\mu, \sigma)} \\
\mu = \beta_{0} + \beta_{1}(t + t_{\delta})
\end{cases}
$$


Dado que $\beta_0$, $\beta_1$, $\sigma$ y $t_{\delta}$ serán las variables aletorias, las distribuciones a priori se definen sobre ellas. 
Para la de la ordenada al origen ($\beta_0$), se suponer una temperatura ambiente de 22° junto con una temperatura inicial del cuerpo entre 36,5° y 37,5°. (temperatura habitual del cuerpo humano); esto daría que la diferencia máxima ocurre en $log(37,5°-22°)=log(15,5°)=2,74$ y la minima se da en $log(36,5°-22°)=log(14,5°)=2,67$. Dado este rango de valores, se deduce que $\mu_{\beta_0} = 2.705$ y $\sigma_{\beta_0} = 0.012$ y queda así definido su *prior*.
Para la distribución de $\beta_1$, se considerará que *r* toma valores entre 0.05 y 0.3 (por ende $\beta_1 = -r \in (-0.2, -0.1)$ ). Con esto se obtiene que $\mu_{\beta_1} = -0.15$ y $\sigma_{\beta_1} = 0.017$.
Ahora, $sigma$ es el desvio de la $T(t) - T_{\mathrm{amb}}$ 
la diferencia máxima entre $T_{\mathrm{amb}}$ y $T(t)$ se da cuando $T(t)$ sea máxima (37,5°), esto da $15,5°$ la diferencia minima se da cuando la temperatura del cuerpo alcanza la temperatura ambiente, es decir la diferencia es 0. Por lo que el desvio de la distribucion de $\sigma$ es $0.91$
$t_{\delta}$ es el tiempo en el que se murió Sergio (hora de muerte). Dado que los ruidos se escuchan a las 5:33hs y a las 6:00hs se constata la presencia de un cuerpo inherte, se supone que Sergio muere entre las 5 y las 6 hs.

$$
\begin{cases}
\beta_0 \sim N_{(2,705, 0.012)} \\
\beta_1 \sim N_{(-0.15, 0.017)} \\
\sigma \sim N^{+}_{(5,17)} \\
t_{\delta} \sim N_{(-1.25, 0.17)}
\end{cases}
$$

# Punto 5: leer el repo de las diapositivas de clases.(presentaciones -> presentacion_06 -> linea 401 a linea 425)

Se considera a la hora de muerte entre las 4 y las 6
beta0=ln(temp a las 6.45 - 22)
temp baja por hora entre 1 y 1.5
si ocurrio a las 4: 
si vale 1: 
maximo: 37.2 - 2.45=34.75
minimo 36.1 - 2.45=33.65
si vale 1.5:
maximo: 37.2 - 2.45*1.5=33.525
minimo: 36.1 - 2.45por1.5=*32.425*
si ocurrio a las 6: 
si vale 1: 
maximo: 37.2 - 0.45=*36.75*
minimo 36.1 - 0.45=35.65
si vale 1.5:
maximo: 37.2 - 0.45*1.5=36.525
minimo: 36.1 - 0.45*1.5=35.426


```{r}
b0 <- 2.517
b1 <- -0.15

data <- tibble(x = c(0, 1.5, 6.75),
       t = c(2.38,2.14,0.53))

parameters <-
  expand.grid(b0 = seq(b0-(3*0.0578),b0+(3*0.0578),length.out = 100),
              b1 = seq(b1-(3*0.017),b1+(3*0.017),length.out = 100)) |>
  mutate(prior = purrr::map2_dbl(b0, b1, ~mvtnorm::dmvnorm(x = c(.x,.y), 
                                                           mean = c(2.517,-0.15), 
                                                           sigma = diag(c(0.0578, 0.017),2))))


rectas_prior <- 
  ggplot(data) +
  geom_point(aes(x=x, y=t), size = 3) +
  geom_abline(data = parameters %>%
  slice_sample(n = 50, weight_by = prior), mapping = aes(slope=b1, intercept=b0),alpha = 0.3, size = 1) +
  lims(y=c(0.5,3))



```
cuerpo en la heladera por eso outlier


# Lo de abajo creo que sirve para el punto 6 en adelante----------


Teniendo en cuenta la información cronológica presentada al inicio del trabajo, se presenta la tabla 1 (por ponerle un número). Se considera como $t = 0$ al horario en el que se le registra la temperatura por primera vez al cuerpo de Sergio (6:45hs), mientras que los demás tiempos son la diferencia, en minutos, entre esa hora y la hora en la que se tomán las restantes temperaturas (8:15hs y 13:30hs).


```{r, eval=FALSE}
#Se arma una tabla con las temperaturas del cuerpo observadas y los tiempos
datos <- data.frame(
  t = c(0),
  temp = c(32.8)
)



t_amb <- 22

stan_data <- list(
  N = nrow(datos),
  t = array(datos$t,dim=1),
  temp_obs= array(datos$temp, dim=1),
  y = array(log(datos$temp - t_amb), dim=1)
)
str(stan_data)
stan_model <- stan(
  file = "modelo.stan",
  chains = 4,
  data = stan_data,
  refresh = 1,
  seed = 200,
  iter=2000,
  warmup = 1000,
  control = list(adapt_delta = 0.95)
)
stan_model

mcmc_trace(
  stan_model, 
  pars = c("beta0", "beta1", "sigma"),
  facet_args = list(nrow = 3)
)

datos_transf <- data.frame(
  t = c(1.5),
  temp = c(log(30.5-22))
)


calc_likelihood <- function(datos, b0, b1, sd){
  lik_i <- dnorm(datos$temp, b0+b1*datos$t, sd)
  return(prod(lik_i))
}

dv1 <-
  datos_transf %>% 
  slice(1) %>% 
  tidyr::crossing(parameters) %>% 
  nest(datos_transf = c(t,temp)) %>%
  mutate(likelihood = purrr::pmap_dbl(list(datos = datos_transf, b0 = parameters$b0, b1 = parameters$b1, sd = 0.95),
                                      calc_likelihood)) %>%
  mutate(posterior = likelihood*prior) %>%
  select(-datos_transf)

rectas_posterior <-
  ggplot(datos_transf) +
  geom_point(aes(x=t, y=temp), size = 3) +
  geom_point(data = data %>% slice(1), aes(x=x, y=t), size=6) +
  geom_abline(data = dv1 %>%
  slice_sample(n = 50, weight_by = posterior), mapping = aes(slope=b1, intercept=b0), alpha = 0.3, size = 1) +
  lims ( x= c(-3,7.5),y=c(0.5,4)) + 
  geom_hline(yintercept = log(14.65), linetype = "dashed")  +
  geom_vline(xintercept = 0)
  

```

todas mezcladas. eso es bueno. el sigma no esta tan bueno. RARI
recorren bien la distri

es amplio el intervalo de prediccion de horario de muerte. tiene sentido porque el posterior se calculo con una sola observacion. 
va aprox entre -2.5 y 0 (esto es dos horas con 30 minutos)

este codigo no funciona:

```{r, eval=FALSE}
datos2 <- data.frame(
  t = c(0,1.5),
  temp = c(32.8,30.5)
)





stan_data2 <- list(
  N = nrow(datos2),
  t = datos2$t,
  temp_obs= datos2$temp,
  y = log(datos2$temp - t_amb)
)
str(stan_data2)
stan_model2 <- stan(
  file = "modelo.stan",
  chains = 4,
  data = stan_data2,
  refresh = 1,
  seed = 200,
  iter= 2500,
  warmup = 1000,
  control = list(adapt_delta = 0.95)
)
stan_model2

mcmc_trace(
  stan_model2, 
  pars = c("beta0", "beta1", "sigma"),
  facet_args = list(nrow = 3)
)

datos2_transf <- data.frame(
  t = c(0,1.5),
  temp = c(log(32.8-22),log(30.5-22))
)


calc_likelihood <- function(datos, b0, b1, sd){
  lik_i <- dnorm(datos$temp, b0+b1*datos$t, sd)
  return(prod(lik_i))
}

dv2 <-
  datos2_transf %>% 
  slice(c(1,2)) %>%
  tidyr::crossing(parameters) %>% 
  nest(datos2_transf = c(t,temp)) %>%
  mutate(likelihood = purrr::pmap_dbl(list(datos = datos2_transf, b0 = parameters$b0, b1 = parameters$b1, sd = 0.95),
                                      calc_likelihood)) %>%
  mutate(posterior = likelihood*parameters$prior) %>%
  select(-datos2_transf) 

rectas_posterior2 <-
  ggplot(datos2_transf) +
 # geom_point(aes(x=t, y=temp), size = 3) +
  geom_point(data = data %>% slice(1:2), aes(x=x, y=t), size=6) +
  geom_abline(data = dv2 %>%
  slice_sample(n = 50, weight_by = posterior), mapping = aes(slope=b1, intercept=b0), alpha = 0.3, size = 1) +
  lims (x = c(-5,5), y=c(0,5)) + 
  geom_hline(yintercept = log(14.65), linetype = "dashed")  +
  geom_vline(xintercept = 0)
  
```

lo que hay que hacer: generar un nuevo modelo stan con los parametros actualizados del que nos dio arriba. 
copiar y pegar codigo de arriba cambiando el modelo stan y la nueva obs. 

media beta0 = 2.5 sd= 0.06



```{r, eval=FALSE}
#Se arma una tabla con las temperaturas del cuerpo observadas y los tiempos
datos <- data.frame(
  t = c(0, 1.5, 6.75),
  temp = c(32.8, 30.5, 23.7)
)



t_amb <- 22

stan_data <- list(
  N = nrow(datos),
  t = datos$t,
  temp_obs= datos$temp,
  y = log(datos$temp - t_amb)
)

stan_model <- stan(
  file = "modelo.stan",
  chains = 4,
  data = stan_data,
  refresh = 1,
  seed = 200
)


```

