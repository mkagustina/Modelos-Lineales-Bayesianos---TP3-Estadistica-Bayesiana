---
title: |
  \vspace{1cm}
  \begin{tabular}{c}
  {\normalsize\textbf{UNIVERSIDAD NACIONAL DE ROSARIO}}\\
  {\Large Facultad de Ciencias Económicas y Estadística}\\
  \\
  \\
  \includegraphics[width=5cm]{LogoUNR.png}\\
  \\
  \\
  {\huge\textbf{Análisis de temperatura corporal postmortem}}\\
  {\huge\textbf{utilizando modelos lineales bayesianos}}\\
  \\
  {\Large Estadística Bayesiana - Trabajo Práctico Nº3}\\
  \end{tabular}
  \vspace{4cm}
author: |
  Alumnas: Agustina Mac Kay, Ailén Salas y Rocío Canteros
date: "Año 2024"
output: pdf_document
editor_options: 
  markdown: 
    wrap: sentence
  chunk_output_type: console
---

```{r setup, echo=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE,
                      fig.height = 3)
```

```{r}
# Carga de librerías
library(ggplot2)
library(dplyr)
library(kableExtra)
library(rstan)
```
# Introducción

La tanatocronología, derivada de las palabras griegas "thanatos" (muerte) y "chronos" (tiempo), es un subcampo de la medicina forense que se centra en determinar el intervalo postmortem, es decir, el tiempo transcurrido desde la muerte hasta el descubrimiento del cadáver.[^1]

[^1]: Fuente: [\textcolor{blue}{\underline{Diccionario Médico: tanatocronología - Clínica Universidad de Navarra}}](https://www.cun.es/diccionario-medico/terminos/tanatocronologia#:~:text=La%20tanatocronolog%C3%ADa%2C%20derivada%20de%20las,hasta%20el%20descubrimiento%20del%20cad%C3%A1ver.)

Desde el momento de la muerte, comienza en el cuerpo humano una serie de procesos químicos y físicos que se conocen como fenómenos cadavéricos. Uno de ellos es el enfriamiento del cuerpo (enfriamiento postmortem o *algor mortis*). En este proceso, la temperatura del cadáver desciende hasta igualarse con la temperatura ambiente. Este descenso ocurre más rápido en las primeras horas después de la muerte.

El objetivo de este trabajo es averiguar la hora de muerte de Sergio Contreras, un hombre que fue hallado muerto desangrado, producto de una herida punzante recibida en el bazo, en su casa en la localidad cordobesa de Salsipuedes. Para resolver este acertijo, se cuenta con la siguiente información sobre la temperatura del cuerpo sin vida del hombre:

* 5:33 hs - El Centro de Atención de Emergencias 911 recibe un llamado de Lidia Benegas, alertando sobre ruidos extraños en la vivienda de su vecino en la localidad de Salsipuedes.

*  6:00 hs - La policia arriba al lugar y se constata la presencia de un cuerpo tendido en el suelo.

* 6:45 hs - Arriba la policía científica al lugar del crimen, se determina la ausencia de signos vitales en el cuerpo de Sergio y el médico forense informa una temperatura corporal de 32.8 °C.

* 8:15hs - Finalizados los procedimientos legales y técnicos, se coloca el cuerpo en la bolsa de óbito para ser trasladado a morgue judicial. El termómetro registra que la temperatura del cadáver es de 30.5 °C.

* 13:30 hs - Comienza la autopsia. El cadáver se encuentra a 23.7 °C.

# Sección con nombre ????

Como el ritmo con el cual el cuerpo pierde temperatura no es constante, se puede pensar que la derivada de la temperatura respecto al tiempo varía con el tiempo. En este caso, la temperatura del cadáver satisface la siguiente ley: 
$$ \frac{dT(t)}{dt} = r[T_{\text{amb}}-T(t)] \tag{1} $$
donde \(T_{\text{amb}}\) es la temperatura ambiente (un valor fijo y conocido), \(r\) es una constante y \(T(t)\) es la función (por ahora desconocida) que describe la temperatura del cuerpo en función del tiempo.

Una posible función \(T(t)\) es: 
$$ T(t)=T_{\text{amb}} + (T_i - T_{\text{amb}}) \cdot e^{-rt} $$
siendo \(T_i\) la temperatura a la que está inicialmente el cuerpo. 

La misma satisface la ecuación \((1)\) ya que:
$$ \frac{dT(t)}{dt} = (T_i - T_{\text{amb}}) \cdot (-r) \cdot e^{-rt} = $$
$$ = -r \cdot [(T_i - T_{\mathrm{amb}}) \cdot e^{-rt}] = $$
$$ = -r \cdot [-T_{\mathrm{amb}}+T_{\mathrm{amb}}+(T_i - T_{\mathrm{amb}}) \cdot e^{-rt}] = $$
$$ = -r \cdot [-T_{\mathrm{amb}}+T(t)] = $$
$$ = r \cdot [T_{\mathrm{amb}} - T(t)] $$
Se grafica a continuación la función $T(t)$ para distintos valores de la constante $r$, considerando una temperatura inicial del cuerpo de 37 Cº y una temperatura ambiente de 23 Cº.

```{r}
# Gráfico de la temperatura del cuerpo a través del tiempo
t_amb <- 23
t_i <- 37
t <- seq(0, 35, by = 1)
r <- c(0.05, 0.1, 0.15, 0.2, 0.3)

funcion_t <- function(t_amb, t_i, t, r) {
  t_amb + (t_i- t_amb) * exp(-r*t)
}

funcion_t_vector <- Vectorize(funcion_t)

df_T <- data.frame(
  t_amb = t_amb,
  t_i = t_i,
  t = rep(seq(0, 35, by = 1), times = length(r)),
  r = rep(r, each = length(t))
)

df_T <- df_T %>% 
  mutate(func_t = funcion_t_vector(df_T$t_amb, df_T$t_i, df_T$t, df_T$r))

ggplot(df_T) +
  geom_line(aes(x = t, y = func_t, color = factor(r)), linewidth = 1) +
  scale_x_continuous(breaks = seq(0, 40, by = 5), name = "Hora (t)") +
  scale_y_continuous(breaks = seq(23, 39, by = 2), name = "T(t)") +
  scale_color_manual(values = c("orchid3", "palegreen3", 'hotpink', 'gold3', 'firebrick3'), name = "r") +
  geom_hline(yintercept = 23, linetype = "dashed") +
  labs(caption = "Figura 1: Gráfica de la función de descenso de la temperatura corporal T(t) para 2 valores de la constante r,\n con una temperatura inicial del cuerpo de 37 Cº hasta alcanzar una temperatura ambiente de 23 Cº") +
  theme_bw() +
  theme(plot.caption = element_text(hjust = 0.5))
```

*r* es una constante que representa la conductividad entre el cuerpo y la superficie de contacto. A valores más altos de *r*, más rápido será el descenso de la temperatura corporal. 

Los órganos abdominales pueden mantener el calor por al menos 24 horas. En las primeras 12 horas se va perdiendo el calor de 0.8 a 1.0 grado centígrado por hora y en las siguientes 12 horas de 0.3 a 0.5 grados centígrados.[^2]

[^2]: Fuente: [\textcolor{blue}{\underline{Fenómenos cadavéricos - Valentina Gómez Hernández}}](https://repository.unad.edu.co/bitstream/handle/10596/51040/vgomezh.pdf?sequence=3&isAllowed=y#:~:text=Enfriamiento%20Cadav%C3%A9rico%20o%20Algor%20Mortis,equilibra%20con%20el%20medio%20ambiente.)

Teniendo en cuenta esta información y lo observado en la Figura 1, se puede considerar que un valor razonable para *r* se encuentra entre 0.1 y 0.2.

Para mayor simplicidad a la hora de contruir un modelo, en lugar de trabajar con la temperatura del cuerpo se decide utilizar la diferencia entre la temperatura del mismo y la temperatura ambiente $T(t) - T_{\mathrm{amb}}$. Además, se define $T_{\mathrm{diff}} = T_i - T_{\mathrm{amb}}$; por lo que se obtiene finalmente que $T(t) - T_{\mathrm{amb}} = T_{\mathrm{diff}} \cdot e ^ {-rt}$.

Se demuestra a continuación un resultado que será de vital importancia para la construcción de un modelo: el logaritmo natural de la nueva variable $T(t) - T_{\mathrm{amb}}$ es una función lineal de *t*.

$$ \ln(T(t) - T_{\mathrm{amb}}) = \ln( T_{\mathrm{diff}} \cdot e^{-rt}) = \ln(T_{\mathrm{diff}}) + (-rt) \cdot \ln (e) = \ln(T_{\mathrm{diff}}) - rt = \beta_{0} + \beta_{1}\cdot t$$

Se puede interpretar a $\beta_{0}$ como el valor del $\ln(T(t) - T_{\mathrm{amb}})$ cuando $t=0$, es decir, al momento de la muerte. Si se exponencian ambos miembros se obtiene que 
$$ T(t=0) - T_{\mathrm{amb}} = e^{\beta_0}$$ 
por lo cual la temperatura al momento de la muerte es igual a $e^{\beta_0} + T_{\mathrm{amb}}$

---

$\beta_{1}$ es cuánto va cambiando el logaritmo de la diferencia entre la temperatura corporal y la temperatura del ambiente por cada hora que transcurre. Por este motivo es la constante de conductividad.

¿Dónde participa la Estadística Bayesiana en todo esto? Al igual que en los temas previamente trabajados, se deben definir una verosimilitud y priors. 

$$
\begin{cases} 
ln(T(t) - T_{\mathrm{amb}}) \sim N_{(\mu, \sigma)} \\
\mu = \beta_{0} + \beta_{1}(t + t_{\delta})
\end{cases}
$$


Dado que $\beta_0$, $\beta_1$, $\sigma$ y $t_{\delta}$ serán las variables aletorias, las distribuciones a priori se definen sobre ellas. 
Para la de la ordenada al origen ($\beta_0$), se considerará una temperatura ambiente minima de -2° y una máxima de 33° junto con una temperatura inicial de 37° (temperatura habitual del cuerpo humano); esto daría que la diferencia máxima ocurre en el minimo de $T_{\mathrm{amb}}$ y la minima se da en el máximo de $T_{\mathrm{amb}}$. (min = 4, máx = 39) Como se está trabajando con $ln(T_i - T_{\mathrm{amb}})$, el valor minimo será $ln(4) = 1.386$ y el máximo será $ln(39) = 3.664$. Dado este rango de valores, se deduce que $\mu_{\beta_0} = 2.525$ y $\sigma_{\beta_0} = 0.380$ y queda así definido su *prior*.
Para la distribución de $\beta_1$, se considerará que *r* toma valores entre 0.05 y 0.3 (por ende $\beta_1 = -r \in (-0.3, -0.05)$ ). Con esto se obtiene que $\mu_{\beta_1} = -0.175$ y $\sigma_{\beta_1} = 0.042$.
Ahora, $sigma$ es el desvio de la $T(t) - T_{\mathrm{amb}}$ 
la diferencia máxima entre $T_{\mathrm{amb}}$ y $T(t)$ se da cuando $T(t)$ sea máxima (37°) y $T_{\mathrm{amb}}$ sea minima (-2°), dicha diferencia en 39; y la diferencia minima se da cuando la temperatura del cuerpo alcanza la temperatura ambiente, es decir la diferencia es 0. Por lo que el desvio de la distribucion de $\sigma$ es 6.5
$t_{\delta}$ es el tiempo en el que se murió Sergio (hora de muerte). Dado que los ruidos se escuchan a las 5:33hs y a las 6:00hs se constata la presencia de un cuerpo inherte, se supone que Sergio muere entre las 5 y las 6 hs.

$$
\begin{cases}
\beta_0 \sim N_{(2.525, 0.38)} \\
\beta_1 \sim N_{(-0.175, 0.042)} \\
\sigma \sim N^{+}_{(0,6.5)} \\
t_{\delta} \sim N_{(-1.2, 0.15)}
\end{cases}
$$

# Punto 5: leer el repo de las diapositivas de clases.(presentaciones -> presentacion_06 -> linea 401 a linea 425)

```{r}
b0 <- 2.525
b1 <- -0.175
sd <- 6 #Valor fijo cualquier para sigma
t_delta <- -1.2

data <- tibble(x = c(0, 1.5, 6.75),
       y = rnorm(3, mean = b0 + b1*(x + t_delta), sd = sd))

parameters <-
  expand.grid(b0 = seq(b0-(3*0.38),b0+(3*0.38),length.out = 100),
              b1 = seq(b1-(3*0.042),b1+(3*0.042),length.out = 100)) |>
  mutate(prior = purrr::map2_dbl(b0, b1, ~mvtnorm::dmvnorm(x = c(.x,.y), 
                                                           mean = c(2.525,-0.175), 
                                                           sigma = diag(c(0.38, 0.042),2))))


rectas_prior <- 
  ggplot(data) +
  geom_point(aes(x=x, y=y), size = 3) +
  geom_abline(data = parameters %>%
  slice_sample(n = 50, weight_by = prior), mapping = aes(slope=b1, intercept=b0),alpha = 0.3, size = 1) 

```


# Lo de abajo creo que sirve para el punto 6 en adelante----------


Teniendo en cuenta la información cronológica presentada al inicio del trabajo, se presenta la tabla 1 (por ponerle un número). Se considera como $t = 0$ al horario en el que se le registra la temperatura por primera vez al cuerpo de Sergio (6:45hs), mientras que los demás tiempos son la diferencia, en minutos, entre esa hora y la hora en la que se tomán las restantes temperaturas (8:15hs y 13:30hs).

```{r, eval=FALSE}
#Se arma una tabla con las temperaturas del cuerpo observadas y los tiempo
datos <- data.frame(
  t = c(0, 90, 405),
  temp = c(32.8, 30.5, 23.7)
)

kable(datos)

t_amb <- 22
temp_obs <- datos$temp
stan_data <- list(
  N = 3,
  t = datos$t,
  temp_obs = temp_obs,
  y = log(temp_obs - t_amb)
)

stan_model <- stan(
  file = "modelo.stan",
  chains = 4,
  data = stan_data,
  refresh = 1,
  seed = 
)


```

